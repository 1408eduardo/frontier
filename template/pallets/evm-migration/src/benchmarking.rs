//! Benchmarking setup for pallet-evm-migration
#![cfg(feature = "runtime-benchmarks")]
use super::*;

#[allow(unused)]
use crate::Pallet as EvmMigration;
use frame_benchmarking::v2::*;
use frame_system::RawOrigin;

use sp_core::{U256, H160, H256};
use sp_std::str::FromStr;
use sp_io::hashing::blake2_256;
use scale_codec::Encode;

const SEED: u32 = 0;
type Index = u32;

#[benchmarks(where 
	T : crate::Config + pallet_evm::Config + pallet_balances::Config,
	T::Balance : From<u64>,
	sp_core::H160: From<<T as frame_system::Config>::AccountId>,
)]
mod benchmarks {

	use super::*;
	#[benchmark]
	pub fn migrate_account_codes(x: Linear<1,10_000>) {
	// Random bytecode - 200 (rows) * 76 (cols) / 2 = 7600 bytes
	let contract_bytecode = hex::decode(concat!("2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212","2083013580151581146107c557600080fd5b80915050925092905056fea26469706673582212",)).expect("bad hex string");
	// let contract_bytecode = hex::decode(concat!("A4")).expect("bad hex string");

	let mut params: Vec<(H160, Vec<u8>)> = Vec::new();
	for i in 0..x {
		let account : T::AccountId = account("coa", i, SEED);
		let h160 : H160 = account.into();
		params.push((h160, contract_bytecode.clone()));
	}
	#[extrinsic_call]
	_(RawOrigin::Root, params);
	}

	#[benchmark]
	/// We write this benchmark not creating the accounts in the first place
	/// i.e.  these accounts are not assumed to have ED > 0 
	pub fn migrate_account_balances_and_nonces(x: Linear<1, 10_000>) {
		let idx : Index = 1000;
		let balance : u64 = 1 << 20;
		let mut params : Vec<(T::AccountId, T::Balance, T::Index)> = Vec::new();
		for i in 0..x {
			let account : T::AccountId = account("account", i, SEED);
			//                                     Vary nonce just for fun 
			params.push((account , balance.into(), (idx+i).into()));
		}
		#[extrinsic_call]
		_(RawOrigin::Root, params);
	}


	#[benchmark]
	fn migrate_account_storage(x : Linear<1, 10_000>) {
		let mut storage : Vec<(H256, H256)> = Vec::new();
		let random_idx : usize = ( U256::from(("random_idx", SEED).using_encoded(blake2_256)) % U256::from(x) ).as_u32() as usize; 
		let addr : H160 = H160::from_str("0000000000000000000000000000000000000001").unwrap();
		for i in 0..x {
			let key : H256 = ("key", i, SEED).using_encoded(blake2_256).into();
			let val : H256 = ("val", i, SEED).using_encoded(blake2_256).into();
			storage.push((key, val));
		}
		let r = storage[random_idx].clone();
		let (test_key, test_val) = (r.0, r.1);
		#[extrinsic_call]
		_(RawOrigin::Root, addr, storage);
		// Verify 
		assert_eq!(pallet_evm::AccountStorages::<T>::get(addr, test_key), test_val);


	}
}